<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Snail Colony Server</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.0/pixi.min.js"></script>
  <script src="map.js"></script>
    <style>
      body { font-family: sans-serif; margin: 20px; }
      button { margin-right: 5px; }
      #logs { display: flex; gap: 10px; margin-top: 20px; }
      .log-col { flex: 1; background: #f5f5f5; border: 1px solid #ccc; padding: 5px; height: 150px; overflow: auto; }
      .log-col h3 { margin-top: 0; }
    </style>
</head>
<body>
  <h1>Snail Colony Server</h1>
  <div>
    <button id="startBtn">Start Game</button>
    <button id="refreshBtn">Refresh Lobby</button>
    <span id="error" style="color:red; margin-left:10px;"></span>
  </div>
  <h2>Players</h2>
  <ul id="players"></ul>
  <h2>Map</h2>
  <div id="map" style="width:400px;height:400px;border:1px solid #ccc;"></div>
  <div id="logs">
    <div class="log-col">
      <h3>IN</h3>
      <div id="inLogs"></div>
    </div>
    <div class="log-col">
      <h3>OUT</h3>
      <div id="outLogs"></div>
    </div>
    <div class="log-col">
      <h3>System</h3>
      <div id="sysLogs"></div>
    </div>
  </div>
  <script>
    const inLogs = document.getElementById('inLogs');
    const outLogs = document.getElementById('outLogs');
    const sysLogs = document.getElementById('sysLogs');
    const playersList = document.getElementById('players');
    const errorEl = document.getElementById('error');

    function log(el, msg) {
      const line = document.createElement('div');
      const time = new Date().toLocaleTimeString();
      line.textContent = `[${time}] ${msg}`;
      el.appendChild(line);
      el.scrollTop = el.scrollHeight;
    }

    function renderLobby(data) {
      playersList.innerHTML = '';
      const players = Array.isArray(data.players)
        ? data.players
        : Array.from(data.players || [], ([name, p]) => ({ name, ready: p.ready }));
      for (const p of players) {
        const li = document.createElement('li');
        li.textContent = `${p.name}${p.ready ? ' (ready)' : ''}`;
        playersList.appendChild(li);
      }
    }

    async function loadMap() {
      try {
        const res = await fetch('/map/lobby');
        const map = await res.json();
        initMapView(map);
      } catch (err) {
        log(sysLogs, 'Map load failed');
      }
    }

    async function refresh() {
      log(outLogs, 'GET /lobby/rooms');
      const res = await fetch('/lobby/rooms');
      const data = await res.json();
      renderLobby(data);
    }

    document.getElementById('refreshBtn').onclick = refresh;
    refresh();
    loadMap();

    async function startGame() {
      log(outLogs, 'POST /lobby/start');
      const res = await fetch('/lobby/start', { method: 'POST' });
      if (res.ok) {
        errorEl.textContent = '';
        log(sysLogs, 'Game started');
      } else {
        const err = await res.json();
        errorEl.textContent = err.message;
        log(sysLogs, 'Start failed: ' + err.message);
      }
    }

    document.getElementById('startBtn').onclick = startGame;

    const ws = new WebSocket(`ws://${location.host}/ws`);
    ws.onopen = () => log(sysLogs, 'WebSocket connected');
    ws.onclose = () => log(sysLogs, 'WebSocket closed');
    ws.onerror = () => log(sysLogs, 'WebSocket error');
    ws.onmessage = (ev) => {
      try {
        const msg = JSON.parse(ev.data);
        if (msg.t === 'Log' && msg.dir === 'IN') {
          log(inLogs, msg.msg);
        } else if (msg.t === 'LobbyState') {
          renderLobby(msg);
        }
      } catch {}
    };
  </script>
</body>
</html>
