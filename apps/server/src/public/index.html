<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Snail Colony Server</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.0/pixi.min.js"></script>
  <script src="/ui/map.js"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap"
    rel="stylesheet"
  />
  <style>
    :root {
      --soil-light: #444444;
      --moss: #3E6B3E;
      --dew-dark: #2384B8;
      --glow: #1DE9B6;
      --amber: #FFC107;
    }
    body {
      font-family: 'Nunito', sans-serif;
      background: var(--soil-light);
      color: var(--dew-dark);
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 2vmin;
    }
    h1, h2 {
      text-align: center;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1vmin;
      justify-content: center;
      margin-bottom: 1vmin;
    }
    .controls label {
      display: flex;
      align-items: center;
      gap: 0.5vmin;
    }
    .controls input[type="range"] {
      width: 10vmin;
    }
    button {
      background: var(--glow);
      color: var(--soil-light);
      border: none;
      padding: 0.5em 1em;
      border-radius: 0.5em;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }
    button:hover:not(:disabled) {
      background: var(--amber);
    }
    button:active:not(:disabled) {
      transform: scale(0.97);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #startBtn {
      background: var(--amber);
    }
    #map {
      width: min(80vw, 80vh);
      border: 0.1em solid var(--dew-dark);
    }
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5vmin;
      margin-top: 1vmin;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5vmin;
      color: var(--dew-dark);
    }
    .legend-swatch {
      width: 1em;
      height: 1em;
      border: 0.1em solid var(--dew-dark);
    }
    #logs {
      display: flex;
      flex-wrap: wrap;
      gap: 1vmin;
      margin-top: 2vmin;
      width: 100%;
      max-width: 90vw;
    }
    .log-col {
      flex: 1 1 20vmin;
      background: var(--moss);
      border: 0.1em solid var(--dew-dark);
      padding: 0.5vmin;
      height: 20vh;
      overflow: auto;
      color: var(--dew-dark);
    }
    .log-col h3 {
      margin-top: 0;
    }
  </style>
</head>
<body>
  <h1>Snail Colony Server</h1>
  <div class="controls">
    <button id="startBtn">Start Game</button>
    <button id="refreshBtn">Refresh Lobby</button>
    <label>W
      <input type="range" id="widthRange" min="3" max="20" value="5" />
      <span id="widthVal">5</span>
    </label>
    <label>H
      <input type="range" id="heightRange" min="3" max="20" value="5" />
      <span id="heightVal">5</span>
    </label>
    <button id="genMapBtn">Generate Map</button>
    <span id="error" style="color:var(--amber); margin-left:1vmin;"></span>
  </div>
  <h2>Players</h2>
  <ul id="players"></ul>
  <h2>Map</h2>
  <div id="map"></div>
  <h3>Terrain Legend</h3>
  <div id="terrainLegend" class="legend"></div>
  <div id="logs">
    <div class="log-col">
      <h3>IN</h3>
      <div id="inLogs"></div>
    </div>
    <div class="log-col">
      <h3>OUT</h3>
      <div id="outLogs"></div>
    </div>
    <div class="log-col">
      <h3>System</h3>
      <div id="sysLogs"></div>
    </div>
  </div>
  <script>
    const inLogs = document.getElementById('inLogs');
    const outLogs = document.getElementById('outLogs');
    const sysLogs = document.getElementById('sysLogs');
    const playersList = document.getElementById('players');
    const errorEl = document.getElementById('error');
    const startBtn = document.getElementById('startBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const genMapBtn = document.getElementById('genMapBtn');
    const widthRange = document.getElementById('widthRange');
    const heightRange = document.getElementById('heightRange');
    const widthVal = document.getElementById('widthVal');
    const heightVal = document.getElementById('heightVal');
    startBtn.disabled = true;

    function log(el, msg) {
      const line = document.createElement('div');
      const time = new Date().toLocaleTimeString();
      line.textContent = `[${time}] ${msg}`;
      el.appendChild(line);
      el.scrollTop = el.scrollHeight;
    }

    function renderLobby(data) {
      playersList.innerHTML = '';
      const players = Array.isArray(data.players)
        ? data.players
        : Array.from(data.players || [], ([name, p]) => ({ name, ready: p.ready }));
      for (const p of players) {
        const li = document.createElement('li');
        li.textContent = `${p.name}${p.ready ? ' (ready)' : ''}`;
        playersList.appendChild(li);
      }
      const allReady = players.length > 0 && players.every((p) => p.ready);
      startBtn.disabled = !allReady;
    }

    async function loadMap() {
      try {
        const res = await fetch('/map/lobby');
        const map = await res.json();
        initMapView(map);
      } catch (err) {
        log(sysLogs, 'Map load failed: ' + (err?.message || err));
      }
    }

    async function refresh() {
      log(outLogs, 'GET /lobby/rooms');
      const res = await fetch('/lobby/rooms');
      const data = await res.json();
      renderLobby(data);
    }

    function bindAsync(btn, handler) {
      btn.addEventListener('click', async () => {
        btn.disabled = true;
        try {
          await handler();
        } finally {
          btn.disabled = false;
        }
      });
    }

    bindAsync(refreshBtn, refresh);
    function sync(slider, display) {
      display.textContent = slider.value;
    }
    widthRange.addEventListener('input', () => sync(widthRange, widthVal));
    heightRange.addEventListener('input', () => sync(heightRange, heightVal));
    sync(widthRange, widthVal);
    sync(heightRange, heightVal);
    bindAsync(genMapBtn, async () => {
      const w = widthRange.value;
      const h = heightRange.value;
      log(outLogs, `POST /map/lobby/generate?w=${w}&h=${h}`);
      const res = await fetch(`/map/lobby/generate?w=${w}&h=${h}`, {
        method: 'POST',
      });
      const map = await res.json();
      initMapView(map);
    });

    async function startGame() {
      log(outLogs, 'POST /lobby/start');
      const res = await fetch('/lobby/start', { method: 'POST' });
      if (res.ok) {
        errorEl.textContent = '';
        log(sysLogs, 'Game started');
        await loadMap();
      } else {
        const err = await res.json();
        errorEl.textContent = err.message;
        log(sysLogs, 'Start failed: ' + err.message);
      }
    }

    bindAsync(startBtn, startGame);

    renderTerrainLegend('terrainLegend');
    refresh();
    loadMap();

    const ws = new WebSocket(`ws://${location.host}/ws`);
    ws.onopen = () => log(sysLogs, 'WebSocket connected');
    ws.onclose = () => log(sysLogs, 'WebSocket closed');
    ws.onerror = () => log(sysLogs, 'WebSocket error');
    ws.onmessage = (ev) => {
      try {
        const msg = JSON.parse(ev.data);
        if (msg.t === 'Log' && msg.dir === 'IN') {
          log(inLogs, msg.msg);
        } else if (msg.t === 'LobbyState') {
          renderLobby(msg);
        }
      } catch {}
    };
  </script>
</body>
</html>
