<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Snail Colony Server</title>
    <style>
      body { font-family: sans-serif; margin: 20px; }
      #state { background: #f5f5f5; padding: 10px; border: 1px solid #ccc; height: 200px; overflow: auto; }
      button { margin-right: 5px; }
      #map { width: 512px; height: 384px; margin-top: 20px; border: 1px solid #ccc; }
      #logs { display: flex; gap: 10px; margin-top: 20px; }
      .log-col { flex: 1; background: #f5f5f5; border: 1px solid #ccc; padding: 5px; height: 150px; overflow: auto; }
      .log-col h3 { margin-top: 0; }
    </style>
</head>
<body>
  <h1>Snail Colony Server</h1>
  <div>
    <button id="createBtn">Create Game</button>
    <input id="roomId" placeholder="Room ID" />
    <button id="startBtn">Start</button>
    <button id="loadBtn">Load</button>
    <button id="redrawBtn">Redraw Map</button>
  </div>
  <div id="map"></div>
    <h2>State</h2>
    <pre id="state"></pre>
    <div id="logs">
      <div class="log-col">
        <h3>IN</h3>
        <div id="inLogs"></div>
      </div>
      <div class="log-col">
        <h3>OUT</h3>
        <div id="outLogs"></div>
      </div>
      <div class="log-col">
        <h3>System</h3>
        <div id="sysLogs"></div>
      </div>
    </div>
    <script src="https://unpkg.com/pixi.js@7.x/dist/pixi.min.js"></script>
    <script src="map.js"></script>
    <script>
      const stateEl = document.getElementById('state');
      const roomInput = document.getElementById('roomId');
      const inLogs = document.getElementById('inLogs');
      const outLogs = document.getElementById('outLogs');
      const sysLogs = document.getElementById('sysLogs');

      function log(el, msg) {
        const line = document.createElement('div');
        const time = new Date().toLocaleTimeString();
        line.textContent = `[${time}] ${msg}`;
        el.appendChild(line);
        el.scrollTop = el.scrollHeight;
      }

      document.getElementById('createBtn').onclick = async () => {
        log(outLogs, 'POST /lobby/room');
        const res = await fetch('/lobby/room', { method: 'POST' });
        const data = await res.json();
        roomInput.value = data.roomId;
        log(sysLogs, `Created room ${data.roomId}`);
      };

      document.getElementById('startBtn').onclick = async () => {
        const id = roomInput.value;
        if (!id) return;
        log(outLogs, `POST /lobby/room/${id}/start`);
        await fetch(`/lobby/room/${id}/start`, { method: 'POST' });
        log(sysLogs, `Start requested for ${id}`);
      };

      document.getElementById('loadBtn').onclick = async () => {
        const id = roomInput.value;
        if (!id) return;
        log(outLogs, `POST /lobby/room/${id}/load`);
        await fetch(`/lobby/room/${id}/load`, { method: 'POST' });
        log(sysLogs, `Load requested for ${id}`);
      };

      const ws = new WebSocket(`ws://${location.host}/ws`);
      ws.onopen = () => log(sysLogs, 'WebSocket connected');
      ws.onclose = () => log(sysLogs, 'WebSocket closed');
      ws.onerror = () => log(sysLogs, 'WebSocket error');
      let latestMap;
      document.getElementById('redrawBtn').onclick = () => {
        ws.send(JSON.stringify({ t: 'RequestRoomState' }));
      };
      ws.onmessage = (ev) => {
        stateEl.textContent = ev.data;
        log(inLogs, ev.data);
        try {
          const msg = JSON.parse(ev.data);
          if (msg.t === 'RoomState') {
            latestMap = msg.map;
            window.initMapView(latestMap);
          }
        } catch {}
      };
    </script>
  </body>
</html>
