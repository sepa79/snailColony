<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Snail Colony Server</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.0/pixi.min.js"></script>
  <script src="/ui/map.js"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap"
    rel="stylesheet"
  />
  <style>
    :root {
      --soil: #2B2B2B;
      --moss: #3E6B3E;
      --dew: #4AAFD9;
      --glow: #1DE9B6;
      --amber: #FFC107;
    }
    body {
      font-family: 'Nunito', sans-serif;
      margin: 20px;
      background: var(--soil);
      color: var(--dew);
    }
    button {
      margin-right: 5px;
      background: var(--glow);
      color: var(--soil);
      border: none;
      padding: 4px 8px;
    }
    #logs {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .log-col {
      flex: 1;
      background: var(--moss);
      border: 1px solid var(--dew);
      padding: 5px;
      height: 150px;
      overflow: auto;
      color: var(--dew);
    }
    .log-col h3 {
      margin-top: 0;
    }
    #startBtn {
      background: var(--amber);
    }
  </style>
</head>
<body>
  <h1>Snail Colony Server</h1>
  <div>
    <button id="startBtn">Start Game</button>
    <button id="refreshBtn">Refresh Lobby</button>
    <span id="error" style="color:var(--amber); margin-left:10px;"></span>
  </div>
  <h2>Players</h2>
  <ul id="players"></ul>
  <h2>Map</h2>
  <div id="map" style="width:400px;height:400px;border:1px solid var(--dew);"></div>
  <div id="logs">
    <div class="log-col">
      <h3>IN</h3>
      <div id="inLogs"></div>
    </div>
    <div class="log-col">
      <h3>OUT</h3>
      <div id="outLogs"></div>
    </div>
    <div class="log-col">
      <h3>System</h3>
      <div id="sysLogs"></div>
    </div>
  </div>
  <script>
    const inLogs = document.getElementById('inLogs');
    const outLogs = document.getElementById('outLogs');
    const sysLogs = document.getElementById('sysLogs');
    const playersList = document.getElementById('players');
    const errorEl = document.getElementById('error');

    function log(el, msg) {
      const line = document.createElement('div');
      const time = new Date().toLocaleTimeString();
      line.textContent = `[${time}] ${msg}`;
      el.appendChild(line);
      el.scrollTop = el.scrollHeight;
    }

    function renderLobby(data) {
      playersList.innerHTML = '';
      const players = Array.isArray(data.players)
        ? data.players
        : Array.from(data.players || [], ([name, p]) => ({ name, ready: p.ready }));
      for (const p of players) {
        const li = document.createElement('li');
        li.textContent = `${p.name}${p.ready ? ' (ready)' : ''}`;
        playersList.appendChild(li);
      }
    }

    async function loadMap() {
      try {
        const res = await fetch('/map/lobby');
        const map = await res.json();
        initMapView(map);
      } catch (err) {
        log(sysLogs, 'Map load failed: ' + (err?.message || err));
      }
    }

    async function refresh() {
      log(outLogs, 'GET /lobby/rooms');
      const res = await fetch('/lobby/rooms');
      const data = await res.json();
      renderLobby(data);
    }

    document.getElementById('refreshBtn').onclick = refresh;
    refresh();
    loadMap();

    async function startGame() {
      log(outLogs, 'POST /lobby/start');
      const res = await fetch('/lobby/start', { method: 'POST' });
      if (res.ok) {
        errorEl.textContent = '';
        log(sysLogs, 'Game started');
        await loadMap();
      } else {
        const err = await res.json();
        errorEl.textContent = err.message;
        log(sysLogs, 'Start failed: ' + err.message);
      }
    }

    document.getElementById('startBtn').onclick = startGame;

    const ws = new WebSocket(`ws://${location.host}/ws`);
    ws.onopen = () => log(sysLogs, 'WebSocket connected');
    ws.onclose = () => log(sysLogs, 'WebSocket closed');
    ws.onerror = () => log(sysLogs, 'WebSocket error');
    ws.onmessage = (ev) => {
      try {
        const msg = JSON.parse(ev.data);
        if (msg.t === 'Log' && msg.dir === 'IN') {
          log(inLogs, msg.msg);
        } else if (msg.t === 'LobbyState') {
          renderLobby(msg);
        }
      } catch {}
    };
  </script>
</body>
</html>
